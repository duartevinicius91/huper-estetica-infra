name: Deploy Applications

on:
  workflow_dispatch:
    inputs:
      backend_branch:
        description: 'Backend branch to deploy'
        required: false
        default: 'develop'
        type: string
      frontend_branch:
        description: 'Frontend branch to deploy'
        required: false
        default: 'develop'
        type: string
      backend_image_tag:
        description: 'Backend Docker image tag'
        required: false
        default: 'latest'
        type: string
      frontend_image_tag:
        description: 'Frontend Docker image tag'
        required: false
        default: 'latest'
        type: string
      deploy_backend:
        description: 'Deploy backend application'
        required: false
        default: true
        type: boolean
      deploy_frontend:
        description: 'Deploy frontend application'
        required: false
        default: true
        type: boolean
      deploy_caddy:
        description: 'Deploy Caddy reverse proxy'
        required: false
        default: true
        type: boolean
      backend_branch_for_caddy:
        description: 'Backend branch to get Caddyfile from'
        required: false
        default: 'develop'
        type: string

jobs:
  deploy-backend:
    if: ${{ github.event.inputs.deploy_backend != 'false' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Build and push Docker image
        run: |
          BACKEND_BRANCH="${{ github.event.inputs.backend_branch || 'develop' }}"
          BACKEND_TAG="${{ github.event.inputs.backend_image_tag || 'latest' }}"
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash << EOF
            set -e
            export BACKEND_BRANCH="${BACKEND_BRANCH}"
            export BACKEND_TAG="${BACKEND_TAG}"
            
            cd ~/huper-abby/huper-estetica || exit
            git fetch origin
            git checkout ${BACKEND_BRANCH} || git checkout master
            git pull origin ${BACKEND_BRANCH} || git pull origin master
            
            # Login to Docker Hub
            echo '${{ secrets.DOCKERHUB_ACCESS_TOKEN }}' | docker login -u duartevinicius91 --password-stdin
            
            # Build application with Gradle
            ./gradlew build -x test
            
            # Build Docker image
            docker build -f src/main/docker/Dockerfile.jvm -t duartevinicius91/huper-estetica:${BACKEND_TAG} .
            docker push duartevinicius91/huper-estetica:${BACKEND_TAG}
            
            # Tag as latest if not already
            if [ "${BACKEND_TAG}" != "latest" ]; then
              docker tag duartevinicius91/huper-estetica:${BACKEND_TAG} duartevinicius91/huper-estetica:latest
              docker push duartevinicius91/huper-estetica:latest
            fi
            
            echo "✅ Backend image built and pushed successfully"
          EOF

      - name: Deploy backend container
        run: |
          BACKEND_TAG="${{ github.event.inputs.backend_image_tag || 'latest' }}"
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash << EOF
            set -e
            export BACKEND_TAG="${BACKEND_TAG}"
            
            # Pull the latest image
            echo '${{ secrets.DOCKERHUB_ACCESS_TOKEN }}' | docker login -u duartevinicius91 --password-stdin
            docker pull duartevinicius91/huper-estetica:${BACKEND_TAG}
            
            # Create network if it doesn't exist
            docker network create huper-network || true
            
            # Stop and remove old container
            docker stop huper-estetica || true
            docker rm huper-estetica || true
            
            # Start new container
            docker run -d \
              --name huper-estetica \
              --restart unless-stopped \
              --network huper-network \
              -p 8080:8080 \
              duartevinicius91/huper-estetica:${BACKEND_TAG}
            
            echo "✅ Backend deployed successfully with tag: \${BACKEND_TAG}"
          EOF

  deploy-frontend:
    if: ${{ github.event.inputs.deploy_frontend != 'false' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Build and push Docker image
        run: |
          FRONTEND_BRANCH="${{ github.event.inputs.frontend_branch || 'develop' }}"
          FRONTEND_TAG="${{ github.event.inputs.frontend_image_tag || 'latest' }}"
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash << EOF
            set -e
            export FRONTEND_BRANCH="${FRONTEND_BRANCH}"
            export FRONTEND_TAG="${FRONTEND_TAG}"
            
            cd ~/huper-abby/huper-estetica-front || exit
            git fetch origin
            git checkout ${FRONTEND_BRANCH} || git checkout master
            git pull origin ${FRONTEND_BRANCH} || git pull origin master
            
            # Login to Docker Hub
            echo '${{ secrets.DOCKERHUB_ACCESS_TOKEN }}' | docker login -u duartevinicius91 --password-stdin
            
            # Build and push image
            docker build -t duartevinicius91/huper-estetica-front:${FRONTEND_TAG} .
            docker push duartevinicius91/huper-estetica-front:${FRONTEND_TAG}
            
            # Tag as latest if not already
            if [ "${FRONTEND_TAG}" != "latest" ]; then
              docker tag duartevinicius91/huper-estetica-front:${FRONTEND_TAG} duartevinicius91/huper-estetica-front:latest
              docker push duartevinicius91/huper-estetica-front:latest
            fi
            
            echo "✅ Frontend image built and pushed successfully"
          EOF

      - name: Deploy frontend container
        run: |
          FRONTEND_TAG="${{ github.event.inputs.frontend_image_tag || 'latest' }}"
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash << EOF
            set -e
            export FRONTEND_TAG="${FRONTEND_TAG}"
            
            # Pull the latest image
            echo '${{ secrets.DOCKERHUB_ACCESS_TOKEN }}' | docker login -u duartevinicius91 --password-stdin
            docker pull duartevinicius91/huper-estetica-front:${FRONTEND_TAG}
            
            # Create network if it doesn't exist
            docker network create huper-network || true
            
            # Stop and remove old container
            docker stop huper-estetica-frontend || true
            docker rm huper-estetica-frontend || true
            
            # Start new container
            docker run -d \
              --name huper-estetica-frontend \
              --restart unless-stopped \
              --network huper-network \
              -p 80:80 \
              duartevinicius91/huper-estetica-front:${FRONTEND_TAG}
            
            echo "✅ Frontend deployed successfully with tag: \${FRONTEND_TAG}"
          EOF

  deploy-caddy:
    if: ${{ github.event.inputs.deploy_caddy != 'false' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Caddy
        run: |
          BACKEND_BRANCH="${{ github.event.inputs.backend_branch_for_caddy || github.event.inputs.backend_branch || 'develop' }}"
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash << EOF
            set -e
            export BACKEND_BRANCH="${BACKEND_BRANCH}"
            
            # Clone or update backend repository to get Caddyfile
            if [ ! -d ~/huper-abby/huper-estetica ]; then
              mkdir -p ~/huper-abby
              git clone -b ${BACKEND_BRANCH} ${{ secrets.BACKEND_REPO_URL || 'https://github.com/duartevinicius91/huper-estetica.git' }} ~/huper-abby/huper-estetica || \
                git clone -b master ${{ secrets.BACKEND_REPO_URL || 'https://github.com/duartevinicius91/huper-estetica.git' }} ~/huper-abby/huper-estetica
            else
              cd ~/huper-abby/huper-estetica
              git fetch origin
              git checkout ${BACKEND_BRANCH} || git checkout master
              git pull origin ${BACKEND_BRANCH} || git pull origin master
            fi
            
            # Create network if it doesn't exist
            docker network create huper-network || true
            
            # Create volumes if they don't exist
            docker volume create caddy_data || true
            docker volume create caddy_config || true
            
            # Stop and remove old container
            docker stop caddy || true
            docker rm caddy || true
            
            # Start Caddy container
            docker run -d \
              --name caddy \
              --restart unless-stopped \
              --network huper-network \
              -p 80:80 \
              -p 443:443 \
              -v ~/huper-abby/huper-estetica/Caddyfile:/etc/caddy/Caddyfile:ro \
              -v caddy_data:/data \
              -v caddy_config:/config \
              caddy:2-alpine
            
            echo "✅ Caddy deployed successfully"
          EOF
